<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRUA Puzzle Â· Season 1</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">GRUA</div>
      <div class="meta">
        <div class="title">CAMPUS MAP Â· Season 1</div>
        <div class="subtitle">claimed=true ìŠ¬ë¡¯ë§Œ í¼ì¦ì´ ì—´ë¦½ë‹ˆë‹¤</div>
      </div>
    </div>
    <div class="status ok" id="status">
      <span class="dot" aria-hidden="true"></span>
      <span class="text">Firestore ì—°ê²°ë¨ Â· ì‹¤ì‹œê°„ ë™ê¸°í™” ëŒ€ê¸°ì¤‘</span>
    </div>
  </header>

  <main class="layout">
    <section class="panel mapPanel">
      <div class="panelTitle">í•™êµ ë§µ</div>
      <div class="schoolMapStub">
        <div class="stubCard">
          <div class="stubTitle">MAP UI Placeholder</div>
          <div class="stubText">
            ê¸°ì¡´ â€œí•™êµ ë§µ UIâ€ë¥¼ ì—¬ê¸° ì˜ì—­ì— ê·¸ëŒ€ë¡œ ìœ ì§€/ë¶™ì—¬ë„£ì„¸ìš”.<br />
            í¼ì¦ì€ ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ ì—´ë¦½ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </section>

    <section class="panel puzzlePanel">
      <div class="panelTitle">
        í¼ì¦ ë³´ë“œ <span class="hint">(images/puzzle.png Â· 4x4)</span>
      </div>

      <div class="puzzleWrap">
        <div class="puzzleBoard" id="puzzleBoard"></div>
      </div>

      <div class="legend">
        <div class="legendItem"><span class="chip open"></span> ì—´ë¦° ì¹¸ (claimed=true)</div>
        <div class="legendItem"><span class="chip closed"></span> ë‹«íŒ ì¹¸</div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footLeft">Firestore: <code>game/season1/slots/01~16</code></div>
    <div class="footRight">GitHub Pages</div>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // âœ… ë„ˆëŠ” ì—¬ê¸°ë§Œ ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const boardEl = document.getElementById("puzzleBoard");
    const statusEl = document.getElementById("status");

    const ROWS = 4;
    const COLS = 4;
    const TILE_W = 25;
    const TILE_H = 25;
    const DOC_IDS = Array.from({ length: 16 }, (_, i) => String(i + 1).padStart(2, "0"));

    // 01 ì¢Œìƒë‹¨, 16 ìš°í•˜ë‹¨ (í–‰ìš°ì„ )
    function idToRowCol(id) {
      const idx = parseInt(id, 10) - 1;
      return { row: Math.floor(idx / COLS), col: idx % COLS };
    }
    function posPercent(step) {
      return (step * 100) / (COLS - 1); // 0, 33.33, 66.66, 100
    }

    function setStatus(ok, text) {
      statusEl.classList.toggle("ok", !!ok);
      statusEl.classList.toggle("bad", !ok);
      statusEl.querySelector(".text").textContent = text;
    }

    function buildTiles() {
      boardEl.innerHTML = "";
      for (const id of DOC_IDS) {
        const { row, col } = idToRowCol(id);

        const tile = document.createElement("div");
        tile.className = "tile closed";
        tile.dataset.id = id;

        tile.style.top = `${row * TILE_H}%`;
        tile.style.left = `${col * TILE_W}%`;
        tile.style.width = `${TILE_W}%`;
        tile.style.height = `${TILE_H}%`;
        tile.style.backgroundPosition = `${posPercent(col)}% ${posPercent(row)}%`;

        // íƒ€ì¼ë³„ ë”œë ˆì´(ìë™) â€” ë” â€œì—´ë¦¼ ì—°ì¶œâ€ ê°™ì•„ì§
        tile.style.setProperty("--delay", (parseInt(id, 10) * 28) % 240);

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = id;
        tile.appendChild(badge);

        const lock = document.createElement("div");
        lock.className = "lock";
        lock.innerHTML = `<div class="lockIcon">ğŸ”’</div><div class="lockText">LOCKED</div>`;
        tile.appendChild(lock);

        boardEl.appendChild(tile);
      }
    }

    function setTileClaimed(id, claimed) {
      const tile = boardEl.querySelector(`.tile[data-id="${id}"]`);
      if (!tile) return;

      if (claimed) {
        tile.classList.remove("closed");
        tile.classList.add("open");
      } else {
        tile.classList.remove("open");
        tile.classList.add("closed");
      }
    }

    // âœ… ì—¬ê¸°ë¶€í„° â€œê³ ì¥ ì•ˆ ë‚˜ëŠ” ë°©ì‹â€ í•µì‹¬:
    // ì»¬ë ‰ì…˜ì„ í•œ ë²ˆì— ì½ì§€ ë§ê³ , ë¬¸ì„œ 16ê°œë¥¼ ê°ê° êµ¬ë…í•œë‹¤.
    function subscribeAllDocs(db) {
      let okCount = 0;

      for (const id of DOC_IDS) {
        const ref = doc(db, "game", "season1", "slots", id);

        onSnapshot(
          ref,
          (snap) => {
            // ë¬¸ì„œê°€ ì—†ì–´ë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            const data = snap.exists() ? (snap.data() || {}) : {};
            setTileClaimed(id, !!data.claimed);

            // ìƒíƒœ ë¬¸êµ¬ëŠ” ëŒ€ì¶©ë§Œ(ë„ˆ ìˆ˜ì •í•  í•„ìš” ì—†ê²Œ)
            okCount++;
            setStatus(true, `ë™ê¸°í™” ì¤‘â€¦ (${Math.min(okCount, 16)}/16)`);
            if (okCount >= 16) setStatus(true, `ë™ê¸°í™” ì™„ë£Œ Â· ${new Date().toLocaleTimeString()}`);
          },
          () => {
            // íŠ¹ì • ë¬¸ì„œë§Œ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ê³„ì† ë™ì‘
            setTileClaimed(id, false);
            setStatus(false, "ì¼ë¶€ ë¬¸ì„œ ì½ê¸° ì‹¤íŒ¨ (Rules/ê¶Œí•œ í™•ì¸)");
          }
        );
      }
    }

    // Init
    buildTiles();

    try {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      setStatus(true, "Firestore ì—°ê²°ë¨ Â· ì‹¤ì‹œê°„ ë™ê¸°í™” ì‹œì‘");
      subscribeAllDocs(db);
    } catch (e) {
      console.error(e);
      setStatus(false, "Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ (firebaseConfig í™•ì¸)");
    }
  </script>
</body>
</html>
