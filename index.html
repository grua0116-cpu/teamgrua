<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Season1 Node Map Test</title>
  <style>
    :root{
      --bg0:#0e1412;
      --bg1:#101a16;
      --text:#e7f1ec;
      --muted:#9fb5ad;
      --accent:#47d3a6;
      --danger:#ff6b6b;
      --ok:#7CFFB2;

      --brick1:#8a3c2f;
      --brick2:#6f2f25;
      --brick3:#a0503f;
      --mortar:#2a1814;

      --shadow: rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #163022 0%, transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, #1a2a24 0%, transparent 60%),
                  linear-gradient(180deg,var(--bg0),var(--bg1));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{ width:min(980px, 100%); display:grid; gap:14px; }
    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px 16px;
      box-shadow: 0 10px 30px var(--shadow);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .title{ margin:0 0 6px 0; font-size:18px; font-weight:800; }
    .sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,.18);
      white-space:nowrap;
      align-self:center;
    }

    .map{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 14px 36px var(--shadow);
      background:
        radial-gradient(800px 400px at 30% 20%, rgba(71,211,166,.16) 0%, transparent 60%),
        radial-gradient(700px 420px at 75% 70%, rgba(71,211,166,.10) 0%, transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .map::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 56px 56px;
      opacity:.18;
      pointer-events:none;
    }

    /* ✅ SVG wires */
    svg.wires{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.9;
    }
    svg.wires line{
      stroke: rgba(231,241,236,.26);
      stroke-width: 0.8;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.25));
    }

    .node{
      position:absolute;
      transform: translate(-50%,-50%);
      width:42px;
      height:42px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.28);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .node:hover{
      transform: translate(-50%,-50%) scale(1.05);
      border-color: rgba(71,211,166,.55);
      box-shadow: 0 14px 28px rgba(0,0,0,.42);
    }
    .node:active{ transform: translate(-50%,-50%) scale(.98); }
    .node .label{ font-size:12px; color: rgba(231,241,236,.85); letter-spacing:.4px; }
    .node.unset .label{ color: rgba(159,181,173,.95); }

    /* ✅ Completed => BRICK TILE */
    .node.claimed{
      width:58px; height:58px;
      border-radius:12px;
      cursor:default;
      border:1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(0deg, rgba(0,0,0,.25), rgba(0,0,0,.25)),
        linear-gradient(90deg, var(--mortar) 2px, transparent 2px) 0 0 / 20px 20px,
        linear-gradient(var(--mortar) 2px, transparent 2px) 0 0 / 20px 20px,
        linear-gradient(180deg, var(--brick3), var(--brick1));
      box-shadow: 0 16px 36px rgba(0,0,0,.55);
    }
    .node.claimed:hover{ transform: translate(-50%,-50%); border-color: rgba(255,255,255,.14); }
    .node.claimed .label{
      font-size:13px; font-weight:800; color: rgba(255,255,255,.92);
      text-shadow: 0 2px 6px rgba(0,0,0,.55);
    }

    .statusbar{
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
    }
    .status{ font-size:12px; color:var(--muted); line-height:1.35; white-space:pre-wrap; }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius:12px;
      padding:9px 11px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{ border-color: rgba(71,211,166,.45); }
    .btn:active{ transform: translateY(1px); }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(420px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,.65);
      padding:14px;
    }
    .modal h3{ margin:6px 6px 4px 6px; font-size:15px; }
    .modal p{ margin:0 6px 10px 6px; color:var(--muted); font-size:12px; line-height:1.35; }
    .row{ display:flex; gap:10px; padding:6px; }
    input{
      flex:1; padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    input:focus{ border-color: rgba(71,211,166,.55); }
    .actions{ display:flex; gap:10px; justify-content:flex-end; padding:6px; }
    .btn.primary{
      border-color: rgba(71,211,166,.55);
      background: rgba(71,211,166,.12);
    }
    .hint{
      padding:0 6px 8px 6px;
      font-size:12px;
      color: var(--muted);
      min-height:16px;
    }
    .hint.ok{ color: var(--ok); }
    .hint.bad{ color: var(--danger); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="title">Season 1 · Node Map (Fresh Start)</h1>
        <p class="sub">
          노드 클릭 → 암호 입력 → 정답이면 <b>claimed=true</b>로 업데이트되고 <b>벽돌 타일</b>로 완성됩니다.<br>
          지금은 <b>01만</b> 실제 검증/업데이트가 동작합니다.
        </p>
      </div>
      <div class="pill">Firestore: game/season1/slots/01~16</div>
    </div>

    <div class="map" id="map"></div>

    <div class="statusbar">
      <div class="status" id="status">준비됨.</div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="btnReload">새로고침(상태 재로딩)</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>암호 입력</h3>
      <p>슬롯 <b id="slotIdText">01</b> 을(를) 해금합니다.</p>
      <div class="row">
        <input id="answerInput" type="password" placeholder="암호" autocomplete="off" />
      </div>
      <div class="hint" id="hint"></div>
      <div class="actions">
        <button class="btn" id="btnCancel">취소</button>
        <button class="btn primary" id="btnSubmit">확인</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // ✅ 네 firebaseConfig (그대로 사용)
    const firebaseConfig = {
      apiKey: "AIzaSyAqwSJ7nXC-AsHp5ifllDzzGA_UBCWQhJE",
      authDomain: "teamgrua-f465c.firebaseapp.com",
      projectId: "teamgrua-f465c",
      storageBucket: "teamgrua-f465c.firebasestorage.app",
      messagingSenderId: "1019914743201",
      appId: "1:1019914743201:web:171550946aafb90ab96fe0"
    };

    // 고정 경로
    const SLOT01_PATH = "game/season1/slots/01";

    // 노드 배치 (0~100 좌표계)
    const NODES = [
      {id:"01", x:12, y:78},
      {id:"02", x:22, y:60},
      {id:"03", x:18, y:36},
      {id:"04", x:30, y:22},

      {id:"05", x:38, y:70},
      {id:"06", x:44, y:48},
      {id:"07", x:40, y:26},
      {id:"08", x:52, y:18},

      {id:"09", x:58, y:72},
      {id:"10",x:66, y:56},
      {id:"11",x:62, y:34},
      {id:"12",x:74, y:22},

      {id:"13",x:78, y:76},
      {id:"14",x:86, y:58},
      {id:"15",x:82, y:36},
      {id:"16",x:90, y:20},
    ];

    // 연결선(예시)
    const EDGES = [
      ["01","02"],["02","03"],["03","04"],
      ["02","06"],["06","10"],["10","14"],
      ["06","07"],["07","08"],["08","12"],["12","16"],
      ["10","11"],["11","15"],
      ["09","10"],["13","14"]
    ];

    const mapEl = document.getElementById("map");
    const statusEl = document.getElementById("status");
    const btnReload = document.getElementById("btnReload");

    const backdrop = document.getElementById("backdrop");
    const slotIdText = document.getElementById("slotIdText");
    const answerInput = document.getElementById("answerInput");
    const hintEl = document.getElementById("hint");
    const btnCancel = document.getElementById("btnCancel");
    const btnSubmit = document.getElementById("btnSubmit");

    let db;
    let slot01Claimed = false;
    let activeSlotId = null;

    function setStatus(msg){ statusEl.textContent = msg; }

    function openModal(slotId){
      activeSlotId = slotId;
      slotIdText.textContent = slotId;
      hintEl.textContent = "";
      hintEl.className = "hint";
      answerInput.value = "";
      backdrop.style.display = "flex";
      setTimeout(()=>answerInput.focus(), 0);
    }
    function closeModal(){
      backdrop.style.display = "none";
      activeSlotId = null;
    }
    function nodeById(id){ return NODES.find(n=>n.id===id); }

    function render(){
      mapEl.innerHTML = "";

      // ✅ SVG wires (항상 보임)
      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("class","wires");
      svg.setAttribute("viewBox","0 0 100 100");
      svg.setAttribute("preserveAspectRatio","none");

      for(const [a,b] of EDGES){
        const pa = nodeById(a), pb = nodeById(b);
        if(!pa || !pb) continue;
        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1", pa.x);
        line.setAttribute("y1", pa.y);
        line.setAttribute("x2", pb.x);
        line.setAttribute("y2", pb.y);
        svg.appendChild(line);
      }
      mapEl.appendChild(svg);

      // ✅ Nodes
      for(const n of NODES){
        const node = document.createElement("div");
        node.className = "node";
        node.style.left = n.x + "%";
        node.style.top  = n.y + "%";

        const isConfigured = (n.id === "01");
        const isClaimed = (n.id === "01") ? slot01Claimed : false;

        if(isClaimed){
          node.classList.add("claimed");
        }else if(!isConfigured){
          node.classList.add("unset");
        }

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = isClaimed ? n.id : (isConfigured ? "?" : "…");
        node.appendChild(label);

        node.addEventListener("click", ()=>{
          if(isClaimed){
            setStatus(`슬롯 ${n.id} 는 이미 완성(claimed=true) 상태입니다.`);
            return;
          }
          if(!isConfigured){
            setStatus(`슬롯 ${n.id} 는 아직 테스트 대상이 아닙니다. (지금은 01만 동작)`);
            return;
          }
          openModal(n.id);
        });

        mapEl.appendChild(node);
      }
    }

    async function loadSlot01(){
      setStatus("Firestore 로딩 중... (slot 01)");
      try{
        const ref = doc(db, SLOT01_PATH);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          slot01Claimed = false;
          setStatus("slot/01 문서가 없습니다. Firestore에 먼저 만들어주세요.");
        }else{
          const data = snap.data();
          slot01Claimed = !!data.claimed;
          setStatus(`로딩 완료. (01 claimed=${slot01Claimed ? "true":"false"})`);
        }
      }catch(e){
        console.error(e);
        setStatus("로드 실패: " + (e?.message ?? String(e)));
      }
      render();
    }

    async function claim01(userAnswer){
      const ref = doc(db, SLOT01_PATH);
      return await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) throw new Error("slot/01 문서가 없습니다. Firestore에 문서를 만들어주세요.");
        const data = snap.data();
        if(String(data.answer ?? "") !== String(userAnswer ?? "")) return {ok:false};
        if(data.claimed === true) return {ok:true, already:true};
        tx.update(ref, { claimed:true });
        return {ok:true, already:false};
      });
    }

    // Modal actions
    btnCancel.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });
    btnReload.addEventListener("click", loadSlot01);

    btnSubmit.addEventListener("click", async ()=>{
      if(activeSlotId !== "01") return;
      const val = answerInput.value.trim();
      if(!val){
        hintEl.textContent = "암호를 입력해줘.";
        hintEl.className = "hint bad";
        return;
      }
      btnSubmit.disabled = true;
      btnCancel.disabled = true;
      hintEl.textContent = "확인 중...";
      hintEl.className = "hint";

      try{
        const res = await claim01(val);
        if(!res.ok){
          hintEl.textContent = "틀렸어. 다시 입력해봐.";
          hintEl.className = "hint bad";
        }else{
          hintEl.textContent = res.already ? "이미 완성된 슬롯이야." : "성공! 벽돌 타일이 완성됐어.";
          hintEl.className = "hint ok";
          await loadSlot01();
          setTimeout(closeModal, 400);
        }
      }catch(e){
        console.error(e);
        hintEl.textContent = e?.message ?? String(e);
        hintEl.className = "hint bad";
      }finally{
        btnSubmit.disabled = false;
        btnCancel.disabled = false;
      }
    });

    // Start
    try{
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      setStatus("Firebase 초기화 완료. Firestore 로딩 시작...");
      await loadSlot01();
    }catch(e){
      console.error(e);
      setStatus("Firebase 초기화 실패: " + (e?.message ?? String(e)));
      render();
    }
  </script>
</body>
</html>
