<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Season1 Node Map Test</title>
  <style>
    :root{
      --bg0:#0e1412;
      --bg1:#101a16;
      --panel:#0f1915cc;
      --text:#e7f1ec;
      --muted:#9fb5ad;
      --accent:#47d3a6;
      --danger:#ff6b6b;
      --ok:#7CFFB2;
      --brick1:#8a3c2f;
      --brick2:#6f2f25;
      --brick3:#a0503f;
      --mortar:#2a1814;
      --shadow: rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #163022 0%, transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, #1a2a24 0%, transparent 60%),
                  linear-gradient(180deg,var(--bg0),var(--bg1));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px 16px;
      box-shadow: 0 10px 30px var(--shadow);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .title{
      font-weight:800;
      letter-spacing:.2px;
      margin:0 0 6px 0;
      font-size:18px;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      white-space:nowrap;
      align-self:center;
    }

    .map{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 14px 36px var(--shadow);
      background:
        radial-gradient(800px 400px at 30% 20%, rgba(71,211,166,.16) 0%, transparent 60%),
        radial-gradient(700px 420px at 75% 70%, rgba(71,211,166,.10) 0%, transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }

    /* faint grid texture */
    .map::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 56px 56px;
      opacity:.18;
      pointer-events:none;
    }

    .edge{
      position:absolute;
      height:2px;
      background: rgba(231,241,236,.18);
      transform-origin:left center;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.25));
      pointer-events:none;
    }

    .node{
      position:absolute;
      transform: translate(-50%,-50%);
      width:42px;
      height:42px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.28);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .node:hover{
      transform: translate(-50%,-50%) scale(1.05);
      border-color: rgba(71,211,166,.55);
      box-shadow: 0 14px 28px rgba(0,0,0,.42);
    }
    .node:active{
      transform: translate(-50%,-50%) scale(.98);
    }
    .node .label{
      font-size:12px;
      color: rgba(231,241,236,.85);
      letter-spacing:.4px;
    }
    .node.unset .label{ color: rgba(159,181,173,.9); }

    /* Completed => turn node into BRICK TILE */
    .node.claimed{
      width:58px;
      height:58px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      cursor:default;
      background:
        linear-gradient(0deg, rgba(0,0,0,.25), rgba(0,0,0,.25)),
        /* brick pattern */
        linear-gradient(90deg, var(--mortar) 2px, transparent 2px) 0 0 / 20px 20px,
        linear-gradient(var(--mortar) 2px, transparent 2px) 0 0 / 20px 20px,
        linear-gradient(90deg, transparent 10px, rgba(0,0,0,.10) 10px, transparent 11px) 0 0 / 20px 20px,
        linear-gradient(180deg, var(--brick3), var(--brick1));
      box-shadow: 0 16px 36px rgba(0,0,0,.55);
    }
    .node.claimed:hover{ transform: translate(-50%,-50%); border-color: rgba(255,255,255,.14); }
    .node.claimed .label{
      font-size:13px;
      font-weight:800;
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 6px rgba(0,0,0,.55);
    }

    .node.locked{
      outline: 2px solid rgba(124,255,178,.22);
    }

    .statusbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
    }
    .status{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      white-space:pre-wrap;
    }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius:12px;
      padding:9px 11px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{ border-color: rgba(71,211,166,.45); }
    .btn:active{ transform: translateY(1px); }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(420px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,.65);
      padding:14px;
    }
    .modal h3{
      margin:6px 6px 4px 6px;
      font-size:15px;
    }
    .modal p{
      margin:0 6px 10px 6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .row{ display:flex; gap:10px; padding:6px; }
    input{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    input:focus{ border-color: rgba(71,211,166,.55); }
    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding:6px;
    }
    .btn.primary{
      border-color: rgba(71,211,166,.55);
      background: rgba(71,211,166,.12);
    }
    .hint{
      padding:0 6px 8px 6px;
      font-size:12px;
      color: var(--muted);
      min-height:16px;
    }
    .hint.ok{ color: var(--ok); }
    .hint.bad{ color: var(--danger); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="title">Season 1 Â· Node Map (Test)</h1>
        <p class="sub">
          ë…¸ë“œë¥¼ í´ë¦­ â†’ ì•”í˜¸ ì…ë ¥ â†’ ì •ë‹µì´ë©´ <b>claimed=true</b>ë¡œ ì ê¸°ê³ , ê·¸ ë…¸ë“œê°€ <b>ë²½ëŒ íƒ€ì¼</b>ë¡œ ì™„ì„±ë©ë‹ˆë‹¤.<br/>
          ì§€ê¸ˆì€ <b>01ë§Œ</b> ì‹¤ì œ ê²€ì¦/ì—…ë°ì´íŠ¸ê°€ ë™ì‘í•©ë‹ˆë‹¤.
        </p>
      </div>
      <div class="pill" id="pill">Firestore: game/season1/slots/01~16</div>
    </div>

    <div class="map" id="map"></div>

    <div class="statusbar">
      <div class="status" id="status">ì¤€ë¹„ë¨.</div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="btnReload">ìƒˆë¡œê³ ì¹¨(ìƒíƒœ ì¬ë¡œë”©)</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mtitle">
      <h3 id="mtitle">ì•”í˜¸ ì…ë ¥</h3>
      <p id="mdesc">ìŠ¬ë¡¯ <b id="slotIdText">01</b> ì„(ë¥¼) í•´ê¸ˆí•©ë‹ˆë‹¤.</p>
      <div class="row">
        <input id="answerInput" type="password" placeholder="ì•”í˜¸" autocomplete="off" />
      </div>
      <div class="hint" id="hint"></div>
      <div class="actions">
        <button class="btn" id="btnCancel">ì·¨ì†Œ</button>
        <button class="btn primary" id="btnSubmit">í™•ì¸</button>
      </div>
    </div>
  </div>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAqwSJ7nXC-AsHp5ifllDzzGA_UBCWQhJE",
    authDomain: "teamgrua-f465c.firebaseapp.com",
    projectId: "teamgrua-f465c",
    storageBucket: "teamgrua-f465c.firebasestorage.app",
    messagingSenderId: "1019914743201",
    appId: "1:1019914743201:web:171550946aafb90ab96fe0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  console.log("ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ");
</script>

    // 2) ê³ ì • ê²½ë¡œ
    const SEASON_DOC = docPath("game", "season1");
    const SLOTS_COL  = colPath("game", "season1", "slots");

    // 3) ë…¸ë“œ ë°°ì¹˜(16ê°œ) - í™”ë©´ì—ì„œë§Œ ìœ„ì¹˜ë¥¼ ì •í•¨
    const NODES = [
      {id:"01", x:12, y:78},
      {id:"02", x:22, y:60},
      {id:"03", x:18, y:36},
      {id:"04", x:30, y:22},

      {id:"05", x:38, y:70},
      {id:"06", x:44, y:48},
      {id:"07", x:40, y:26},
      {id:"08", x:52, y:18},

      {id:"09", x:58, y:72},
      {id:"10",x:66, y:56},
      {id:"11",x:62, y:34},
      {id:"12",x:74, y:22},

      {id:"13",x:78, y:76},
      {id:"14",x:86, y:58},
      {id:"15",x:82, y:36},
      {id:"16",x:90, y:20},
    ];

    // (ì„ íƒ) ê°„ë‹¨í•œ ì—°ê²°ì„  (ì˜ˆì‹œë¡œ ëª‡ ê°œë§Œ)
    const EDGES = [
      ["01","02"],["02","03"],["03","04"],
      ["02","06"],["06","10"],["10","14"],
      ["06","07"],["07","08"],["08","12"],["12","16"],
      ["10","11"],["11","15"],
      ["09","10"],["13","14"]
    ];

    // ë‚´ë¶€ ìƒíƒœ
    let app, db;
    let slotState = {}; // { "01": {claimed:boolean, answerExists:boolean} ... }
    let activeSlotId = null;

    // ì—˜ë¦¬ë¨¼íŠ¸
    const mapEl = document.getElementById("map");
    const statusEl = document.getElementById("status");
    const btnReload = document.getElementById("btnReload");

    const backdrop = document.getElementById("backdrop");
    const slotIdText = document.getElementById("slotIdText");
    const answerInput = document.getElementById("answerInput");
    const hintEl = document.getElementById("hint");
    const btnCancel = document.getElementById("btnCancel");
    const btnSubmit = document.getElementById("btnSubmit");

    // util: Firestore path helpers (collection/doc êµ¬ë¶„ ì‹¤ìˆ˜ ë°©ì§€)
    function docPath(...segs){ return segs.join("/"); }
    function colPath(...segs){ return segs.join("/"); }

    function setStatus(msg){ statusEl.textContent = msg; }
    function openModal(slotId){
      activeSlotId = slotId;
      slotIdText.textContent = slotId;
      hintEl.textContent = "";
      hintEl.className = "hint";
      answerInput.value = "";
      backdrop.style.display = "flex";
      setTimeout(()=>answerInput.focus(), 0);
    }
    function closeModal(){
      backdrop.style.display = "none";
      activeSlotId = null;
    }
    function nodePos(id){
      return NODES.find(n=>n.id===id);
    }

    function render(){
      mapEl.innerHTML = "";

      // edges ë¨¼ì €
      for (const [a,b] of EDGES){
        const pa = nodePos(a), pb = nodePos(b);
        if(!pa || !pb) continue;
        const dx = pb.x - pa.x;
        const dy = pb.y - pa.y;
        const len = Math.hypot(dx, dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

        const edge = document.createElement("div");
        edge.className = "edge";
        edge.style.left = pa.x + "%";
        edge.style.top  = pa.y + "%";
        edge.style.width = `calc(${len}% * 1)`; // percent ê¸°ë°˜ì´ë¯€ë¡œ ëŒ€ì¶© ëŠë‚Œë§Œ
        // percent ê¸¸ì´ ì™œê³¡ ë°©ì§€í•˜ë ¤ë©´ SVGê°€ ì •ì„ì¸ë°, í…ŒìŠ¤íŠ¸ìš©ì´ë¼ â€œëŠë‚Œâ€ë§Œ ëƒ„
        edge.style.transform = `rotate(${angle}deg)`;
        mapEl.appendChild(edge);
      }

      // nodes
      for(const n of NODES){
        const st = slotState[n.id] ?? { claimed:false, exists:false };

        const node = document.createElement("div");
        node.className = "node";

        // â€œ01ë§Œ ë™ì‘â€ ì¡°ê±´: 01 ì™¸ì—ëŠ” unset ì²˜ë¦¬
        const isConfigured = (n.id === "01");

        if(st.claimed){
          node.classList.add("claimed", "locked");
        }else{
          if(!isConfigured) node.classList.add("unset");
        }

        node.style.left = n.x + "%";
        node.style.top  = n.y + "%";

        const label = document.createElement("div");
        label.className = "label";
        label.textContent = st.claimed ? n.id : (isConfigured ? "?" : "â€¦");
        node.appendChild(label);

        // í´ë¦­ ë¡œì§
        node.addEventListener("click", ()=>{
          if(st.claimed){
            setStatus(`ìŠ¬ë¡¯ ${n.id} ëŠ” ì´ë¯¸ ì™„ì„±(claimed=true) ìƒíƒœì…ë‹ˆë‹¤.`);
            return;
          }
          if(!isConfigured){
            setStatus(`ìŠ¬ë¡¯ ${n.id} ëŠ” ì•„ì§ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤. (ì§€ê¸ˆì€ 01ë§Œ ë™ì‘)`);
            return;
          }
          openModal(n.id);
        });

        mapEl.appendChild(node);
      }
    }

    async function loadStates(){
      setStatus("Firestore ìƒíƒœ ë¡œë”© ì¤‘...");
      slotState = {};
      try{
        // ì§€ê¸ˆì€ í…ŒìŠ¤íŠ¸ë¼ì„œ: 01ë§Œ ì½ì–´ë„ ì¶©ë¶„í•˜ì§€ë§Œ, í˜•íƒœëŠ” 16ì¹¸ ê¸°ì¤€ìœ¼ë¡œ ë‘ 
        const ref01 = doc(db, docPath(SLOTS_COL, "01"));
        const snap = await getDoc(ref01);

        if(snap.exists()){
          const data = snap.data();
          slotState["01"] = {
            exists:true,
            claimed: !!data.claimed
          };
        }else{
          slotState["01"] = { exists:false, claimed:false };
        }

        setStatus(`ë¡œë”© ì™„ë£Œ. (01 claimed=${slotState["01"]?.claimed ? "true" : "false"})`);
      }catch(e){
        console.error(e);
        setStatus("ë¡œë“œ ì‹¤íŒ¨: " + (e?.message ?? String(e)));
      }
      render();
    }

    async function claimSlot01(userAnswer){
      const slotId = "01";
      const slotRef = doc(db, docPath(SLOTS_COL, slotId));

      // íŠ¸ëœì­ì…˜: answer í™•ì¸ + claimed=falseì¼ ë•Œë§Œ claimed=trueë¡œ
      return await runTransaction(db, async (tx) => {
        const snap = await tx.get(slotRef);
        if(!snap.exists()){
          throw new Error("slot/01 ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤. Firestoreì— ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.");
        }
        const data = snap.data();
        const correct = (String(data.answer ?? "") === String(userAnswer ?? ""));
        if(!correct){
          return { ok:false, reason:"wrong" };
        }
        if(data.claimed === true){
          return { ok:true, already:true };
        }
        tx.update(slotRef, { claimed:true });
        return { ok:true, already:false };
      });
    }

    // ì´ë²¤íŠ¸
    btnReload.addEventListener("click", loadStates);
    btnCancel.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    btnSubmit.addEventListener("click", async ()=>{
      if(activeSlotId !== "01") return;

      const val = answerInput.value.trim();
      if(!val){
        hintEl.textContent = "ì•”í˜¸ë¥¼ ì…ë ¥í•´ì¤˜.";
        hintEl.className = "hint bad";
        return;
      }

      btnSubmit.disabled = true;
      btnCancel.disabled = true;
      hintEl.textContent = "í™•ì¸ ì¤‘...";
      hintEl.className = "hint";

      try{
        const res = await claimSlot01(val);
        if(!res.ok){
          hintEl.textContent = "í‹€ë ¸ì–´. ë‹¤ì‹œ ì…ë ¥í•´ë´.";
          hintEl.className = "hint bad";
          return;
        }
        if(res.already){
          hintEl.textContent = "ì´ë¯¸ ì™„ì„±ëœ ìŠ¬ë¡¯ì´ì•¼.";
          hintEl.className = "hint ok";
        }else{
          hintEl.textContent = "ì„±ê³µ! ë²½ëŒ íƒ€ì¼ì´ ì™„ì„±ëì–´.";
          hintEl.className = "hint ok";
        }
        // UI ê°±ì‹ 
        await loadStates();
        setTimeout(closeModal, 450);
      }catch(e){
        console.error(e);
        hintEl.textContent = e?.message ?? String(e);
        hintEl.className = "hint bad";
      }finally{
        btnSubmit.disabled = false;
        btnCancel.disabled = false;
      }
    });

    // ì‹œì‘
    try{
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      setStatus("Firebase ì´ˆê¸°í™” ì™„ë£Œ. ìƒíƒœ ë¡œë”© ì‹œì‘...");
      await loadStates();
    }catch(e){
      console.error(e);
      setStatus("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: " + (e?.message ?? String(e)));
    }
  </script>
</body>
</html>
