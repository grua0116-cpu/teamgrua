<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Season1 Puzzle Map Test</title>

  <style>
    :root{
      --bg0:#0e1412;
      --bg1:#101a16;
      --text:#e7f1ec;
      --muted:#9fb5ad;
      --accent:#47d3a6;
      --danger:#ff6b6b;
      --ok:#7CFFB2;

      --brick1:#8a3c2f;
      --brick3:#a0503f;
      --mortar:#2a1814;

      --shadow: rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #163022 0%, transparent 55%),
                  radial-gradient(900px 500px at 80% 0%, #1a2a24 0%, transparent 60%),
                  linear-gradient(180deg,var(--bg0),var(--bg1));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{ width:min(980px, 100%); display:grid; gap:14px; }
    .top{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px 16px;
      box-shadow: 0 10px 30px var(--shadow);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .title{ margin:0 0 6px 0; font-size:18px; font-weight:800; }
    .sub{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,.18);
      white-space:nowrap;
      align-self:center;
    }

    .stage{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 14px 36px var(--shadow);
      background:
        radial-gradient(800px 400px at 30% 20%, rgba(71,211,166,.16) 0%, transparent 60%),
        radial-gradient(700px 420px at 75% 70%, rgba(71,211,166,.10) 0%, transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .stage::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 56px 56px;
      opacity:.15;
      pointer-events:none;
    }

    /* =========================
       Puzzle layer (16 tiles)
       ========================= */
    .puzzle{
      position:absolute;
      inset: 18px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      z-index: 1;
    }

    .piece{
      position:relative;
      background-image: url("./images/puzzle.png");
      background-repeat: no-repeat;
      background-size: 400% 400%; /* 4x4 => 400% */
      outline: 1px solid rgba(255,255,255,.06);
    }

    /* Locked cover (brick) */
    .cover{
      position:absolute; inset:0;
      background:
        linear-gradient(0deg, rgba(0,0,0,.35), rgba(0,0,0,.35)),
        linear-gradient(90deg, var(--mortar) 2px, transparent 2px) 0 0 / 20px 20px,
        linear-gradient(var(--mortar) 2px, transparent 2px) 0 0 / 20px 20px,
        linear-gradient(180deg, var(--brick3), var(--brick1));
      display:flex;
      align-items:flex-end;
      justify-content:flex-end;
      padding:8px;
      transition: opacity .18s ease;
    }
    .cover .tag{
      font-size:12px;
      color: rgba(255,255,255,.92);
      font-weight:800;
      text-shadow: 0 2px 8px rgba(0,0,0,.6);
      opacity:.9;
    }

    .piece.claimed .cover{
      opacity:0;
      pointer-events:none;
    }

    /* =========================
       Map overlay (nodes + wires)
       ========================= */
    .overlay{
      position:absolute;
      inset: 18px;
      border-radius:14px;
      z-index: 3;
      pointer-events:none; /* wires는 클릭 막기 */
    }
    svg.wires{
      position:absolute; inset:0;
      width:100%; height:100%;
      opacity:.9;
      pointer-events:none;
    }
    svg.wires line{
      stroke: rgba(231,241,236,.26);
      stroke-width: 0.9;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.25));
    }

    .node{
      position:absolute;
      transform: translate(-50%,-50%);
      width:42px;
      height:42px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.28);
      display:grid;
      place-items:center;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      z-index: 10;
      pointer-events:auto; /* 노드만 클릭되게 */
      cursor:pointer;
    }
    .node:hover{
      transform: translate(-50%,-50%) scale(1.05);
      border-color: rgba(71,211,166,.55);
      box-shadow: 0 14px 28px rgba(0,0,0,.42);
    }
    .node:active{ transform: translate(-50%,-50%) scale(.98); }

    .node .label{
      font-size:12px;
      color: rgba(231,241,236,.9);
      letter-spacing:.3px;
      font-weight:800;
    }
    .node.unset{ cursor:default; }
    .node.unset:hover{
      transform: translate(-50%,-50%);
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .node.unset .label{ color: rgba(159,181,173,.95); }

    /* small highlight when claimed */
    .node.claimed{
      outline: 2px solid rgba(124,255,178,.22);
      border-color: rgba(124,255,178,.35);
    }

    .statusbar{
      display:flex; gap:10px;
      align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:10px 12px;
    }
    .status{ font-size:12px; color:var(--muted); line-height:1.35; white-space:pre-wrap; }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius:12px;
      padding:9px 11px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{ border-color: rgba(71,211,166,.45); }
    .btn:active{ transform: translateY(1px); }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(420px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      box-shadow: 0 18px 48px rgba(0,0,0,.65);
      padding:14px;
    }
    .modal h3{ margin:6px 6px 4px 6px; font-size:15px; }
    .modal p{ margin:0 6px 10px 6px; color:var(--muted); font-size:12px; line-height:1.35; }
    .row{ display:flex; gap:10px; padding:6px; }
    input{
      flex:1; padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    input:focus{ border-color: rgba(71,211,166,.55); }
    .actions{ display:flex; gap:10px; justify-content:flex-end; padding:6px; }
    .btn.primary{
      border-color: rgba(71,211,166,.55);
      background: rgba(71,211,166,.12);
    }
    .hint{
      padding:0 6px 8px 6px;
      font-size:12px;
      color: var(--muted);
      min-height:16px;
    }
    .hint.ok{ color: var(--ok); }
    .hint.bad{ color: var(--danger); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 class="title">Season 1 · Puzzle + Map (Test)</h1>
        <p class="sub">
          <b>한 장 이미지(puzzle.png)</b>가 16조각으로 나뉘어 있고, 잠긴 조각은 <b>벽돌 덮개</b>로 가립니다.<br/>
          노드(지도)를 클릭해 암호를 맞추면 해당 조각 덮개가 사라지며 그림이 완성됩니다. (지금은 <b>01만</b> 동작)
        </p>
      </div>
      <div class="pill">./images/puzzle.png</div>
    </div>

    <div class="stage">
      <div class="puzzle" id="puzzle"></div>
      <div class="overlay" id="overlay"></div>
    </div>

    <div class="statusbar">
      <div class="status" id="status">준비됨.</div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="btnReload">새로고침(상태 재로딩)</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>암호 입력</h3>
      <p>슬롯 <b id="slotIdText">01</b> 을(를) 해금합니다.</p>
      <div class="row">
        <input id="answerInput" type="password" placeholder="암호" autocomplete="off" />
      </div>
      <div class="hint" id="hint"></div>
      <div class="actions">
        <button class="btn" id="btnCancel">취소</button>
        <button class="btn primary" id="btnSubmit">확인</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // ✅ 네 firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAqwSJ7nXC-AsHp5ifllDzzGA_UBCWQhJE",
      authDomain: "teamgrua-f465c.firebaseapp.com",
      projectId: "teamgrua-f465c",
      storageBucket: "teamgrua-f465c.firebasestorage.app",
      messagingSenderId: "1019914743201",
      appId: "1:1019914743201:web:171550946aafb90ab96fe0"
    };

    // ✅ Firestore doc (01만 테스트)
    const SLOT01_PATH = "game/season1/slots/01";

    // 16개 슬롯 id
    const IDS = Array.from({length:16}, (_,i)=> String(i+1).padStart(2,"0"));

    // 노드 좌표 (0~100 overlay 좌표)
    const NODES = [
      {id:"01", x:12, y:78},
      {id:"02", x:22, y:60},
      {id:"03", x:18, y:36},
      {id:"04", x:30, y:22},

      {id:"05", x:38, y:70},
      {id:"06", x:44, y:48},
      {id:"07", x:40, y:26},
      {id:"08", x:52, y:18},

      {id:"09", x:58, y:72},
      {id:"10",x:66, y:56},
      {id:"11",x:62, y:34},
      {id:"12",x:74, y:22},

      {id:"13",x:78, y:76},
      {id:"14",x:86, y:58},
      {id:"15",x:82, y:36},
      {id:"16",x:90, y:20},
    ];
    const EDGES = [
      ["01","02"],["02","03"],["03","04"],
      ["02","06"],["06","10"],["10","14"],
      ["06","07"],["07","08"],["08","12"],["12","16"],
      ["10","11"],["11","15"],
      ["09","10"],["13","14"]
    ];

    const puzzleEl = document.getElementById("puzzle");
    const overlayEl = document.getElementById("overlay");
    const statusEl = document.getElementById("status");
    const btnReload = document.getElementById("btnReload");

    const backdrop = document.getElementById("backdrop");
    const slotIdText = document.getElementById("slotIdText");
    const answerInput = document.getElementById("answerInput");
    const hintEl = document.getElementById("hint");
    const btnCancel = document.getElementById("btnCancel");
    const btnSubmit = document.getElementById("btnSubmit");

    let db;
    let activeSlotId = null;

    // 상태: 지금은 01만 Firestore에서 로딩, 나머지는 false
    const claimed = Object.fromEntries(IDS.map(id => [id, false]));

    const isConfigured = (id) => id === "01"; // 테스트용: 01만 클릭/검증

    function setStatus(msg){ statusEl.textContent = msg; }
    function nodeById(id){ return NODES.find(n=>n.id===id); }

    function openModal(slotId){
      activeSlotId = slotId;
      slotIdText.textContent = slotId;
      hintEl.textContent = "";
      hintEl.className = "hint";
      answerInput.value = "";
      backdrop.style.display = "flex";
      setTimeout(()=>answerInput.focus(), 0);
    }
    function closeModal(){
      backdrop.style.display = "none";
      activeSlotId = null;
    }

    function renderPuzzle(){
      puzzleEl.innerHTML = "";

      // 4x4 타일: 한 장 이미지를 위치로 잘라서 보이게
      // tile index => row/col
      IDS.forEach((id, idx)=>{
        const r = Math.floor(idx/4);
        const c = idx % 4;

        const piece = document.createElement("div");
        piece.className = "piece";
        piece.dataset.id = id;

        // 해당 조각이 보여줄 이미지 위치
        // background-position은 0%, 33.333%, 66.666%, 100% 로 맞추는 게 깔끔
        const px = (c * 100) / 3;
        const py = (r * 100) / 3;
        piece.style.backgroundPosition = `${px}% ${py}%`;

        // 덮개(벽돌)
        const cover = document.createElement("div");
        cover.className = "cover";
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.textContent = id;
        cover.appendChild(tag);
        piece.appendChild(cover);

        if(claimed[id]) piece.classList.add("claimed");

        puzzleEl.appendChild(piece);
      });
    }

    function renderOverlay(){
      overlayEl.innerHTML = "";

      // wires
      const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
      svg.setAttribute("class","wires");
      svg.setAttribute("viewBox","0 0 100 100");
      svg.setAttribute("preserveAspectRatio","none");

      for(const [a,b] of EDGES){
        const pa = nodeById(a), pb = nodeById(b);
        if(!pa || !pb) continue;
        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("x1", pa.x);
        line.setAttribute("y1", pa.y);
        line.setAttribute("x2", pb.x);
        line.setAttribute("y2", pb.y);
        svg.appendChild(line);
      }
      overlayEl.appendChild(svg);

      // nodes
      for(const n of NODES){
        const node = document.createElement("div");
        node.className = "node";
        node.style.left = n.x + "%";
        node.style.top  = n.y + "%";

        const label = document.createElement("div");
        label.className = "label";

        if(isConfigured(n.id)){
          label.textContent = n.id;
        }else{
          node.classList.add("unset");
          label.textContent = "·";
        }

        if(claimed[n.id]) node.classList.add("claimed");
        node.appendChild(label);

        node.addEventListener("click", ()=>{
          if(!isConfigured(n.id)){
            setStatus(`슬롯 ${n.id} 는 아직 테스트 대상이 아닙니다. (지금은 01만 동작)`);
            return;
          }
          if(claimed["01"]){
            setStatus("01은 이미 열린 상태입니다.");
            return;
          }
          openModal("01");
        });

        overlayEl.appendChild(node);
      }
    }

    function renderAll(){
      renderPuzzle();
      renderOverlay();
    }

    async function load01(){
      setStatus("Firestore 로딩 중... (slot 01)");
      try{
        const ref = doc(db, SLOT01_PATH);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          claimed["01"] = false;
          setStatus("slot/01 문서가 없습니다. Firestore에 먼저 만들어주세요.");
        }else{
          claimed["01"] = !!snap.data().claimed;
          setStatus(`로딩 완료. (01 claimed=${claimed["01"] ? "true":"false"})`);
        }
      }catch(e){
        console.error(e);
        setStatus("로드 실패: " + (e?.message ?? String(e)));
      }
      renderAll();
    }

    async function claim01(userAnswer){
      const ref = doc(db, SLOT01_PATH);
      return await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()) throw new Error("slot/01 문서가 없습니다. Firestore에 문서를 만들어주세요.");
        const data = snap.data();
        if(String(data.answer ?? "") !== String(userAnswer ?? "")) return {ok:false};
        if(data.claimed === true) return {ok:true, already:true};
        tx.update(ref, { claimed:true });
        return {ok:true, already:false};
      });
    }

    // events
    btnReload.addEventListener("click", load01);
    btnCancel.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

    btnSubmit.addEventListener("click", async ()=>{
      if(activeSlotId !== "01") return;

      const val = answerInput.value.trim();
      if(!val){
        hintEl.textContent = "암호를 입력해줘.";
        hintEl.className = "hint bad";
        return;
      }

      btnSubmit.disabled = true;
      btnCancel.disabled = true;
      hintEl.textContent = "확인 중...";
      hintEl.className = "hint";

      try{
        const res = await claim01(val);
        if(!res.ok){
          hintEl.textContent = "틀렸어. 다시 입력해봐.";
          hintEl.className = "hint bad";
        }else{
          hintEl.textContent = res.already ? "이미 열린 조각이야." : "성공! 조각이 열렸어.";
          hintEl.className = "hint ok";
          await load01();
          setTimeout(closeModal, 350);
        }
      }catch(e){
        console.error(e);
        hintEl.textContent = e?.message ?? String(e);
        hintEl.className = "hint bad";
      }finally{
        btnSubmit.disabled = false;
        btnCancel.disabled = false;
      }
    });

    // start
    try{
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      setStatus("Firebase 초기화 완료. Firestore 로딩 시작...");
      renderAll(); // 먼저 UI 그려놓고
      await load01();
    }catch(e){
      console.error(e);
      setStatus("Firebase 초기화 실패: " + (e?.message ?? String(e)));
      renderAll();
    }
  </script>
</body>
</html>
