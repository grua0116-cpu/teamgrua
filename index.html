<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Season 1</title>
  <link rel="stylesheet" href="./assets/styles.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <div class="title">Season 1 Puzzle</div>
          <div class="sub">
            노드를 클릭 → 힌트 확인 → 암호 입력 → 성공 시 조각 해금<br/>
            (claimed=true인 조각만 그림이 드러납니다)
          </div>
        </div>
        <a class="btn" href="./index.html">새로고침</a>
      </div>

      <div id="toast" class="toast" style="display:none;"></div>

      <div class="board-wrap">
        <div class="board" id="board">
          <div class="grid" id="grid"></div>

          <div class="overlay">
            <svg class="lines" id="lines" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
            <div id="nodes"></div>
          </div>
        </div>
      </div>

      <div class="msg" id="status">불러오는 중…</div>
    </div>
  </div>

  <script type="module">
    import { fetchAllSlots, pad2 } from "./assets/app.js";

    const grid = document.getElementById("grid");
    const nodesEl = document.getElementById("nodes");
    const linesEl = document.getElementById("lines");
    const statusEl = document.getElementById("status");
    const toastEl = document.getElementById("toast");

    // 4x4의 각 타일 중심을 (0~100) 좌표로 만든다.
    function slotCenter(slotNum){
      const idx = slotNum - 1;
      const col = idx % 4;
      const row = Math.floor(idx / 4);
      const x = (col + 0.5) * 25;  // 0~100에서 4등분
      const y = (row + 0.5) * 25;
      return {x, y};
    }

    function showToastFromQuery(){
      const qs = new URLSearchParams(location.search);
      const opened = qs.get("opened");
      if (opened){
        toastEl.style.display = "block";
        toastEl.textContent = `${opened}번 조각이 해금되었습니다.`;
      }
    }

    function renderTiles(map){
      grid.innerHTML = "";
      for (let i=1; i<=16; i++){
        const slot = pad2(i);
        const claimed = !!map?.[slot]?.claimed;

        const tile = document.createElement("div");
        tile.className = "tile" + (claimed ? "" : " locked");

        const idx = i - 1;
        const col = idx % 4;
        const row = Math.floor(idx / 4);
        tile.style.backgroundPosition = `${col * 33.3333}% ${row * 33.3333}%`;

        grid.appendChild(tile);
      }
    }

    function renderNodes(map){
      nodesEl.innerHTML = "";
      linesEl.innerHTML = "";

      // 라인: 01->02->...->16 (원하면 나중에 너의 노드맵 구조대로 바꾸면 됨)
      for (let i=1; i<16; i++){
        const a = slotCenter(i);
        const b = slotCenter(i+1);
        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
        line.setAttribute("class","line");
        line.setAttribute("x1", a.x);
        line.setAttribute("y1", a.y);
        line.setAttribute("x2", b.x);
        line.setAttribute("y2", b.y);
        linesEl.appendChild(line);
      }

      for (let i=1; i<=16; i++){
        const slot = pad2(i);
        const c = slotCenter(i);
        const claimed = !!map?.[slot]?.claimed;

        const node = document.createElement("div");
        node.className = "node" + (claimed ? " open" : "");
        node.textContent = slot;
        node.style.left = c.x + "%";
        node.style.top  = c.y + "%";
        node.dataset.slot = slot;

        node.addEventListener("click", () => {
          location.href = `./hint.html?slot=${encodeURIComponent(slot)}`;
        });

        nodesEl.appendChild(node);
      }
    }

    async function main(){
      showToastFromQuery();
      try{
        const map = await fetchAllSlots();
        renderTiles(map);
        renderNodes(map);

        const opened = Object.values(map).filter(s => s.claimed).length;
        statusEl.textContent = `진행: ${opened} / 16 조각 해금됨`;
      }catch(e){
        console.error(e);
        statusEl.textContent = "불러오기 실패: firebaseConfig/Firestore 경로/규칙 확인";
        statusEl.className = "msg bad";
      }
    }

    main();
  </script>
</body>
</html>
