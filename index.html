<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRUA Puzzle â€“ Season 1</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <!-- ====== í•™êµ ë§µ UI ìœ ì§€ìš© í”„ë ˆì„ (ì›ë˜ ìˆë˜ í—¤ë”/ë„¤ë¹„ ëŠë‚Œìœ¼ë¡œ êµ¬ì„±) ====== -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">GRUA</div>
      <div class="meta">
        <div class="title">CAMPUS MAP Â· Season 1</div>
        <div class="subtitle">claimed=true ìŠ¬ë¡¯ë§Œ í¼ì¦ì´ ì—´ë¦½ë‹ˆë‹¤</div>
      </div>
    </div>

    <div class="status" id="status">
      <span class="dot" aria-hidden="true"></span>
      <span class="text">Firestore ì—°ê²° ì¤€ë¹„ì¤‘â€¦</span>
    </div>
  </header>

  <main class="layout">
    <!-- ì¢Œì¸¡: í•™êµ ë§µ ì˜ì—­(ìœ ì§€) -->
    <section class="panel mapPanel">
      <div class="panelTitle">í•™êµ ë§µ</div>

      <!-- ì—¬ê¸°ì— ê¸°ì¡´ â€œí•™êµ ë§µ UIâ€ ë§ˆí¬ì—…ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ë„ ë¨ -->
      <div class="schoolMapStub">
        <div class="stubCard">
          <div class="stubTitle">MAP UI Placeholder</div>
          <div class="stubText">
            ê¸°ì¡´ â€œí•™êµ ë§µ UIâ€ë¥¼ ì—¬ê¸° ì˜ì—­ì— ê·¸ëŒ€ë¡œ ìœ ì§€/ë³µë¶™í•˜ì„¸ìš”.<br/>
            í¼ì¦ì€ ì˜¤ë¥¸ìª½ íŒ¨ë„ì—ì„œ ì—´ë¦½ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </section>

    <!-- ìš°ì¸¡: í¼ì¦ -->
    <section class="panel puzzlePanel">
      <div class="panelTitle">
        í¼ì¦ ë³´ë“œ <span class="hint">(images/puzzle.png Â· 4x4)</span>
      </div>

      <div class="puzzleWrap">
        <!-- í¼ì¦ í”„ë ˆì„(16ê°œ íƒ€ì¼ absolute) -->
        <div class="puzzleBoard" id="puzzleBoard" aria-label="Puzzle board">
          <!-- JSê°€ 16ì¹¸ ìƒì„± -->
        </div>
      </div>

      <div class="legend">
        <div class="legendItem">
          <span class="chip open"></span> ì—´ë¦° ì¹¸ (claimed=true)
        </div>
        <div class="legendItem">
          <span class="chip closed"></span> ë‹«íŒ ì¹¸
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footLeft">Firestore ê²½ë¡œ: <code>game/season1/slots/01~16</code></div>
    <div class="footRight">ë°°í¬: GitHub Pages</div>
  </footer>

  <!-- ====== Firebase (CDN) ====== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // âœ… ì—¬ê¸°ë§Œ ë³¸ì¸ firebaseConfigë¡œ êµì²´
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ====== DOM ======
    const boardEl = document.getElementById("puzzleBoard");
    const statusEl = document.getElementById("status");

    // ====== Constants ======
    const ROWS = 4;
    const COLS = 4;
    const TILE_W = 25; // %
    const TILE_H = 25; // %
    const DOC_IDS = Array.from({ length: 16 }, (_, i) => String(i + 1).padStart(2, "0"));

    // "01 â†’ ì¢Œìƒë‹¨" ì •í™• ë§¤í•‘(í–‰ ìš°ì„ ):
    // 01 02 03 04
    // 05 06 07 08
    // 09 10 11 12
    // 13 14 15 16
    function idToRowCol(id) {
      const n = parseInt(id, 10);   // 1~16
      const idx = n - 1;            // 0~15
      const row = Math.floor(idx / COLS);
      const col = idx % COLS;
      return { row, col };
    }

    // background-position í¼ì„¼íŠ¸ ê³„ì‚°:
    // background-size: 400% 400%ì¼ ë•Œ, 4ë¶„í• ì€ ìœ„ì¹˜ê°€ 0 / 33.333 / 66.666 / 100
    function posPercent(stepIndex) {
      if (COLS === 1) return 0;
      return (stepIndex * 100) / (COLS - 1);
    }

    // ====== UI Build: 16 tiles absolute ======
    function buildTiles() {
      boardEl.innerHTML = "";
      for (const id of DOC_IDS) {
        const { row, col } = idToRowCol(id);

        const tile = document.createElement("div");
        tile.className = "tile closed";
        tile.dataset.id = id;

        // absolute ì¢Œí‘œ(top/left %) â€” grid ë¯¸ì‚¬ìš©
        tile.style.top = `${row * TILE_H}%`;
        tile.style.left = `${col * TILE_W}%`;
        tile.style.width = `${TILE_W}%`;
        tile.style.height = `${TILE_H}%`;

        // í¼ì¦ ì¡°ê° ë°°ê²½ ìœ„ì¹˜
        tile.style.backgroundPosition = `${posPercent(col)}% ${posPercent(row)}%`;

        // ë¼ë²¨(ë””ë²„ê·¸/ìš´ì˜ ì¤‘ ìˆ¨ê²¨ë„ ë¨)
        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = id;
        tile.appendChild(badge);

        // ë‹«í˜ ì˜¤ë²„ë ˆì´(ë½)
        const lock = document.createElement("div");
        lock.className = "lock";
        lock.innerHTML = `
          <div class="lockIcon" aria-hidden="true">ğŸ”’</div>
          <div class="lockText">LOCKED</div>
        `;
        tile.appendChild(lock);

        boardEl.appendChild(tile);
      }
    }

    // ====== Apply Firestore state ======
    function setTileClaimed(id, claimed) {
      const tile = boardEl.querySelector(`.tile[data-id="${id}"]`);
      if (!tile) return;

      if (claimed) {
        tile.classList.remove("closed");
        tile.classList.add("open");
      } else {
        tile.classList.remove("open");
        tile.classList.add("closed");
      }
    }

    function setStatus(ok, text) {
      statusEl.classList.toggle("ok", !!ok);
      statusEl.classList.toggle("bad", !ok);
      statusEl.querySelector(".text").textContent = text;
    }

    // ====== Init ======
    buildTiles();

    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      setStatus(true, "Firestore ì—°ê²°ë¨ Â· ì‹¤ì‹œê°„ ë™ê¸°í™” ëŒ€ê¸°ì¤‘");
    } catch (e) {
      console.error(e);
      setStatus(false, "Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ (firebaseConfig í™•ì¸)");
    }

    // ì‹¤ì‹œê°„ êµ¬ë…: game/season1/slots (collection)
    // ë¬¸ì„œ: 01~16, í•„ë“œ: claimed(boolean), answer(string)
    if (db) {
      const slotsCol = collection(db, "game", "season1", "slots");

      onSnapshot(
        slotsCol,
        (snap) => {
          // ê¸°ë³¸: ì „ë¶€ ë‹«ìŒ(ë¬¸ì„œ ì—†ê±°ë‚˜ claimed=false í¬í•¨ ëŒ€ë¹„)
          for (const id of DOC_IDS) setTileClaimed(id, false);

          // ë¬¸ì„œ ìˆëŠ” ê²ƒë§Œ ë°˜ì˜
          snap.forEach((doc) => {
            const id = doc.id; // "01"~"16"
            if (!DOC_IDS.includes(id)) return;

            const data = doc.data() || {};
            setTileClaimed(id, !!data.claimed);
          });

          setStatus(true, `ë™ê¸°í™” ì™„ë£Œ Â· ì—…ë°ì´íŠ¸ ${new Date().toLocaleTimeString()}`);
        },
        (err) => {
          console.error(err);
          setStatus(false, "Firestore ì½ê¸° ì‹¤íŒ¨ (Rules/ê¶Œí•œ/ê²½ë¡œ í™•ì¸)");
        }
      );
    }
  </script>
</body>
</html>
