<!-- Firebase (compat, non-module) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
  /***********************
   * 0) Firebase Config
   ************************/
  const firebaseConfig = {
    apiKey: "REPLACE_ME",
    authDomain: "REPLACE_ME",
    projectId: "REPLACE_ME",
    storageBucket: "REPLACE_ME",
    messagingSenderId: "REPLACE_ME",
    appId: "REPLACE_ME",
  };

  // ✅ 1) START 버튼은 Firebase보다 먼저 살아있게
  const introBack = document.getElementById("introBack");
  const introStart = document.getElementById("introStart");
  const introClose = document.getElementById("introClose");

  function hardHideIntro(){
    if(introBack) introBack.style.display = "none";
  }

  introStart?.addEventListener("click", () => {
    hardHideIntro();
    startApp();
  });
  introClose?.addEventListener("click", () => {
    hardHideIntro();
    startApp();
  });

  /***********************
   * UI refs
   ************************/
  const connPill = document.getElementById("connPill");
  const pathPill = document.getElementById("pathPill");
  const roundText = document.getElementById("roundText");
  const advText = document.getElementById("advText");
  const progressText = document.getElementById("progressText");
  const barFill = document.getElementById("barFill");
  const pctEl = document.getElementById("pct");
  const toastEl = document.getElementById("toast");

  const puzzleBack = document.getElementById("puzzleBack");
  const puzzleCard = document.getElementById("puzzleCard");
  const linesSvg = document.getElementById("lines");
  const overlay = document.getElementById("overlay");

  function toast(msg, kind=""){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.className = "toast show " + (kind || "");
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.className = "toast", 2600);
  }

  /***********************
   * 1) Firestore Base Path
   ************************/
  const BASE_PATH = ["game", "season1"]; // 필요시 수정

  /***********************
   * 2) 노드/랜드마크(네 기존 값 그대로 쓰면 됨)
   ************************/
  const NODE_LIST = [
    { docId:"01", typeCode:"IFAP", place:"구역 A-1", x: 120, y: 120 },
    { docId:"02", typeCode:"IFAB", place:"구역 A-2", x: 330, y: 210 },
    { docId:"03", typeCode:"IFEP", place:"구역 A-3", x: 440, y: 115 },
    { docId:"04", typeCode:"IFEB", place:"구역 A-4", x: 560, y: 170 },
    { docId:"05", typeCode:"ILAP", place:"구역 B-1", x: 190, y: 360 },
    { docId:"06", typeCode:"ILAB", place:"구역 B-2", x: 360, y: 325 },
    { docId:"07", typeCode:"ILEP", place:"구역 B-3", x: 470, y: 420 },
    { docId:"08", typeCode:"ILEB", place:"구역 B-4", x: 600, y: 400 },
    { docId:"09", typeCode:"OFAP", place:"구역 C-1", x: 280, y: 495 },
    { docId:"10", typeCode:"OFAB", place:"구역 C-2", x: 420, y: 515 },
    { docId:"11", typeCode:"OFEP", place:"구역 C-3", x: 600, y: 520 },
    { docId:"12", typeCode:"OFEB", place:"구역 C-4", x: 780, y: 380 },
    { docId:"13", typeCode:"OLAP", place:"구역 D-1", x: 650, y: 300 },
    { docId:"14", typeCode:"OLAB", place:"구역 D-2", x: 740, y: 300 },
    { docId:"15", typeCode:"OLEP", place:"구역 D-3", x: 845, y: 470 },
    { docId:"16", typeCode:"OELB", place:"구역 D-4", x: 880, y: 235 },
  ];

  /***********************
   * 3) Firebase boot (compat)
   ************************/
  let db = null;
  let currentRoundId = null;
  let completedThisRound = false;
  let unsubscribeSlots = null;

  function pathDoc(...parts){
    // compat은 문자열 경로가 필요
    return parts.join("/");
  }

  function normalizeAnswer(s){
    return (s ?? "").toString().trim().replace(/\s+/g, " ").toLowerCase();
  }

  function setCompleteUI(isComplete){
    completedThisRound = isComplete;
    if(isComplete){
      puzzleBack?.classList.add("show");
      if(overlay) overlay.style.display = "none";
      if(linesSvg) linesSvg.style.display = "none";
    }else{
      puzzleBack?.classList.remove("show");
      if(overlay) overlay.style.display = "";
      if(linesSvg) linesSvg.style.display = "";
    }
  }

  async function ensureMeta(){
    const metaPath = pathDoc(...BASE_PATH, "meta", "meta");
    const ref = db.doc(metaPath);
    const snap = await ref.get();
    if(!snap.exists){
      await ref.set({ activeRoundId:"R0001", advancing:false, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    }
  }

  function subscribeSlots(roundId){
    if(unsubscribeSlots) unsubscribeSlots();
    currentRoundId = roundId;
    setCompleteUI(false);

    const pathStr = `${BASE_PATH.join("/")}/rounds/${roundId}/slots`;
    if(pathPill) pathPill.textContent = `경로: ${pathStr}`;
    if(roundText) roundText.textContent = `현재 라운드: ${roundId}`;
    if(advText) advText.textContent = "";

    const colPath = pathDoc(...BASE_PATH, "rounds", roundId, "slots");
    unsubscribeSlots = db.collection(colPath).onSnapshot((qs) => {
      if(connPill){
        connPill.textContent = "Firestore 연결: 정상";
        connPill.style.borderColor = "rgba(140,255,200,.35)";
      }

      const byId = new Map();
      qs.forEach(doc => byId.set(doc.id, doc.data()));

      let unlockedCount = 0;
      for(const n of NODE_LIST){
        const d = byId.get(n.docId);
        if(d?.unlocked) unlockedCount++;
      }

      const pct = Math.round((unlockedCount/16)*100);
      if(progressText) progressText.textContent = `${unlockedCount}/16 조각 해금`;
      if(barFill) barFill.style.width = pct + "%";
      if(pctEl) pctEl.textContent = pct + "%";

      setCompleteUI(unlockedCount === 16);
    }, (err) => {
      console.error(err);
      if(connPill){
        connPill.textContent = "Firestore 연결: 오류";
        connPill.style.borderColor = "rgba(255,122,122,.45)";
      }
      toast("Firestore 오류: 경로/규칙/firebaseConfig 확인", "bad");
    });
  }

  async function boot(){
    await ensureMeta();
    const metaPath = pathDoc(...BASE_PATH, "meta", "meta");
    db.doc(metaPath).onSnapshot((snap) => {
      if(!snap.exists) return;
      const m = snap.data() || {};
      const rid = m.activeRoundId || "R0001";
      subscribeSlots(rid);
    });
  }

  function startApp(){
    try{
      connPill && (connPill.textContent = "Firestore 연결: 초기화 중…");
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      boot().catch(e => {
        console.error(e);
        toast("부팅 실패: firebaseConfig/경로/권한", "bad");
      });
    }catch(e){
      console.error(e);
      toast("Firebase 로드/초기화 실패(차단/네트워크)", "bad");
    }
  }

  // 퍼즐 클릭 → world 이동 (라운드 자동화는 필요하면 여기 추가)
  puzzleCard?.addEventListener("click", () => {
    if(!completedThisRound) return;
    window.location.href = "world.html";
  });

  // ✅ 혹시라도 intro가 없는 상황(디버그) 대비: 자동 시작 옵션
  // startApp();
</script>
